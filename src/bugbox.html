<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>BugBox</title>
    <meta name="description" content="A demo">
    <meta name="author" content="Jon Wallace">
    
    <link rel="stylesheet" href="css/styles.css">
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
</head>
<body>
    <h3>BugBox</h3>
    <div class="style-change-stack"><span class="title">Style Change Stack</span><div class="textarea"></div></div>
    <ul class="styles">
        
    </ul>
    
    <div class="js-console">
        <div class='console-output'></div>
        <textarea class="console-input"></textarea>
    </div>
    
    <!-- Instantiate PubNub -->
    <script type="text/javascript">
        var PUBNUB_demo = PUBNUB.init({
            publish_key: 'pub-c-31e8f452-4051-43f9-82c1-25f4c137f164',
            subscribe_key: 'sub-c-59e8f2ec-ca33-11e3-90c5-02ee2ddab7fe'
        });
        
        var currentElementID = '';
        var addRowMarkup = '<tr class="style-rule"><td class="style-name"><input type="text" value="[add new]" />:</td><td class="style-value"><input type="text" /></td><td><button class="bb-btn-addstyle">+</button></td></tr>';
        
        // Subscribe to the demo_tutorial channel
        PUBNUB_demo.subscribe({
            channel: 'demo_tutorial',
            message: function(m){
                currentElementID = m.bb_id;
                
                if(m.command == 'Site_EditElement')
                {
                    var stylesList = '<table>';
                
                    for (var key in m.styles) {
                        stylesList += '<tr class="style-rule"><td class="style-name"><input type="text" value="'+camelToDash(key)+'" readonly />:</td><td class="style-value"><input type="text" value="'+m.styles[key]+'" /></td></tr>';
                    }
                    
                    $('.styles').html(stylesList+addRowMarkup+'</table>')
                        .find('.bb-btn-addstyle');
                    
                    $('.style-value input').on('change', onStyleChange);
                }
                
                if(m.command == 'Site_ConsoleLog')
                {
                    $('.js-console .console-output').append('<div class="log">'+m.log+'</div>');   
                } 
                
                if(m.command == 'Site_ConsoleError')
                {
                    $('.js-console .console-output').append('<div class="log error">'+m.log+'</div>');   
                }
            }
        });
        
        
        $('.js-console .console-input').on('keydown', function(e){
            if(e.which == 13) {
                
                $('.js-console .console-output').append('<div class="log"><span class="bugbox">BugBox sent: </span>'+e.currentTarget.value+'</div>');   
                
                PUBNUB_demo.publish({
                    channel: 'demo_tutorial',
                    message: {
                        command: 'Box_EvalJavascript',
                        js: e.currentTarget.value
                    }
                });
                
                
                e.currentTarget.value = '';
            }
            else if(e.which == 38){
                
            }
            console.log(e.which);
        });
        
        
        
        function onStyleChange(e){
            var $target = $(e.currentTarget);
            var $rule = $target.closest('.style-rule');

            changeStyle($rule.find('.style-name input').attr('readonly', true).val(), $target.val());
            if($rule.find('.bb-btn-addstyle').remove().length > 0){
                $('.styles table').append(addRowMarkup).find('.style-rule:last').find('.style-value input').on('change', onStyleChange);   
            }
        }
        
        function changeStyle(style, value){
            $('.style-change-stack .textarea').append(camelToDash(style)+': '+value+';<br />');
            PUBNUB_demo.publish({
                channel: 'demo_tutorial',
                message: {
                    command: 'Box_UpdateStyle',
                    bb_id: currentElementID,
                    style: style,
                    value: value
                }
            });
        }
        
        $('.style-change-stack .textarea').on('click', function(e){
            if (document.selection) {
                var range = document.body.createTextRange();
                range.moveToElementText(e.currentTarget);
                range.select();
            } else if (window.getSelection) {
                var range = document.createRange();
                range.selectNode(e.currentTarget);
                window.getSelection().addRange(range);
            }
        });
        
        
        function camelToDash(str) {
          return str.replace(/\W+/g, '-')
                    .replace(/([a-z\d])([A-Z])/g, '$1-$2')
                    .toLowerCase();
       }
        
        function selectText(containerid) {
            if (document.selection) {
                var range = document.body.createTextRange();
                range.moveToElementText(document.getElementById(containerid));
                range.select();
            } else if (window.getSelection) {
                var range = document.createRange();
                range.selectNode(document.getElementById(containerid));
                window.getSelection().addRange(range);
            }
        }
        
        //window.location.reload()
        
        
        
        
    </script>
</body>
</html>