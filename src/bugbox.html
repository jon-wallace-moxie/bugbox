<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>BugBox</title>
    <meta name="description" content="A demo">
    <meta name="author" content="Jon Wallace">
    
    <link rel="stylesheet" href="css/styles.css">
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
</head>
<body>
    <h1>BugBox</h1>
    <div class="style-change-stack"><span class="title">Style Change Stack</span><textarea readonly></textarea></div>
    <ul class="styles">
        
    </ul>
    
    <!-- Instantiate PubNub -->
    <script type="text/javascript">
        var PUBNUB_demo = PUBNUB.init({
            publish_key: 'pub-c-31e8f452-4051-43f9-82c1-25f4c137f164',
            subscribe_key: 'sub-c-59e8f2ec-ca33-11e3-90c5-02ee2ddab7fe'
        });
        
        var currentElementID = '';
        var addRowMarkup = '<tr class="style-rule"><td class="style-name"><input type="text" value="[add new]" /></td><td class="style-value"><input type="text" /></td><td><button class="bb-btn-addstyle">+</button></td></tr>';
        
        // Subscribe to the demo_tutorial channel
        PUBNUB_demo.subscribe({
            channel: 'demo_tutorial',
            message: function(m){
                console.log(m);
                
                currentElementID = m.bb_id;
                
                if(m.command == 'Site_EditElement')
                {
                    var stylesList = '<table>';
                
                    for (var key in m.styles) {
                        stylesList += '<tr class="style-rule"><td class="style-name"><input type="text" value="'+key+'" readonly />:</td><td class="style-value"><input type="text" value="'+m.styles[key]+'" /></td></tr>';
                    }
                    
                    $('.styles').html(stylesList+addRowMarkup+'</table>')
                        .find('.bb-btn-addstyle');
                    
                    $('.style-value input').on('change', onStyleChange);
                }
                
                
            }
        });
        
        function onStyleChange(e){
            var $target = $(e.currentTarget);
            var $rule = $target.closest('.style-rule');

            changeStyle($rule.find('.style-name input').attr('readonly', true).val(), $target.val());
            if($rule.find('.bb-btn-addstyle').remove().length > 0){
                $('.styles table').append(addRowMarkup).find('.style-rule:last').find('.style-value input').on('change', onStyleChange);   
            }
        }
        
        function changeStyle(style, value){
            $('.style-change-stack textarea').append(camelToDash(style)+': '+value+';\n');
            PUBNUB_demo.publish({
                channel: 'demo_tutorial',
                message: {
                    command: 'Box_UpdateStyle',
                    bb_id: currentElementID,
                    style: style,
                    value: value
                }
            });
        }
        
        $('.style-change-stack').on('click', function(e){
            $(this).find('textarea').select();
        });
        
        
        function camelToDash(str) {
          return str.replace(/\W+/g, '-')
                    .replace(/([a-z\d])([A-Z])/g, '$1-$2')
                    .toLowerCase();
       }
        
        
    </script>
</body>
</html>