<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>BugBox Demo</title>
    <meta name="description" content="A demo">
    <meta name="author" content="Jon Wallace">
    
    <link rel="stylesheet" href="css/styles.css">
    
    <script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
</head>
<body>
    <h1>A demo website</h1>
    <a id="bb-button" href="" class="bb-component"></a>
    
    <p>A paragraph to test stuff :)</p>
    
    <ul class="numbers">
        
    </ul>
    
    <!-- Instantiate PubNub -->
    <script type="text/javascript">
        var PUBNUB_demo = PUBNUB.init({
            publish_key: 'pub-c-31e8f452-4051-43f9-82c1-25f4c137f164',
            subscribe_key: 'sub-c-59e8f2ec-ca33-11e3-90c5-02ee2ddab7fe'
        });
        
        // Subscribe to the demo_tutorial channel
        PUBNUB_demo.subscribe({
            channel: 'demo_tutorial',
            message: function(m){
                console.log(m);
                if(m.command == 'Box_UpdateStyle'){
                    $('[bb-elementid="'+m.bb_id+'"]').get(0).style[m.style] = m.value;
                    console.log(m.value);
                }
            
            }
        });
        
        //add highlight
        var $bbHighlight = $('body').append('<span id="bb-highlight" class="bb-component"></span>').find('#bb-highlight');
        
        var totalChunks = 0;
        var channel = 'demo_tutorial';
        function sendData(msg){
            if(calculate_payload_size(channel, msg) <= 30000){
                totalChunks++;
                PUBNUB_demo.publish({
                    channel: channel,
                    message: msg
                });
            }
            else{
                var halfLength = msg.length/2;
                sendData(msg.slice(0, halfLength));
                sendData(msg.slice(halfLength));
            }
        }
        
        // Calculating a PubNub Message Payload Size.
        function calculate_payload_size( channel, message ) {
            return encodeURIComponent(
                channel + JSON.stringify(message)
            ).length + 100;
        }
        
        
        
        //add bb-elementid's to all elemnts on the page
        var currHoverID = null;
        $('body *').not('.bb-component').each(function(i, el){
            $(el).attr('bb-elementid', 'bb-element-'+i);
        }).on('click', function(e){
            e.preventDefault;
            
            $this = $(e.currentTarget);
            
            var defaultStyles = getComputedStyle($('html').get(0));
            var elementStyles = getComputedStyle($this.get(0));
            var diffStyles = {};

            for (var key in defaultStyles) {
                if (defaultStyles.hasOwnProperty(key)) {
                    if(isNaN(key)){ //if its not a number
                        if(defaultStyles[key] != elementStyles[key])
                            diffStyles[key] = elementStyles[key];
                    }
                }
            }
                
            PUBNUB_demo.publish({
                channel: channel,
                message: {
                    command: 'Site_EditElement',
                    bb_id: $this.attr('bb-elementid'),
                    styles: diffStyles
                }
            });
            return false;
        }).on('mouseover', function(e){
            $this = $(e.currentTarget);

            if(currHoverID == $this.attr('bb-elementid')) return;
            currHoverID = $this.attr('bb-elementid');
            
            $bbHighlight.css({
                top: $this.offset().top,
                left: $this.offset().left,
                width: $this.innerWidth(),
                height: $this.innerHeight(),
                display: 'block',
                opacity: 0.5
            }).fadeOut(100);
        });
        
    </script>
</body>
</html>